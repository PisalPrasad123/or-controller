<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="or-editor-shell">
    <style>

        :host {
            height: 100vh;
            display: flex;
            flex-direction: row;
        }

        #editor {
            flex-grow: 1;
            flex-shrink: 0;
            flex-basis: auto;
            display: none;
        }

        #editorToggleButton {
            position: fixed;
            top: 3px;
            right: 3px;
            width: 18px;
            height: 18px;
            background: transparent;
            border: 2px dotted var(--default-primary-color, white);
        }

        #editorToggleButton:hover {
            background: var(--default-primary-color, white);
            border: none;
        }

        #editorToggleButton:focus {
            outline: 0;
        }

        #consoleContainer {
            background-color: darkred;
            flex-grow: 0;
            flex-shrink: 0;
            flex-basis: 100vw;
            overflow: hidden;
            resize: horizontal;
            display: flex;
        }

        #consoleResizeHandle {
            background-color: black;
            height: 100vh;
            flex: 0 0 0;
            cursor: pointer;
            position: relative;
        }

        #consoleLabel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-50%) rotate(-90deg);
            color: var(--or-lightgreen, white);
            font-style: italic;
        }

        #console {
            height: 100vh;
            flex: 1 0 auto;
        }
    </style>
    <template>
        <iframe id="editor" frameborder="0" src="about:blank"></iframe>

        <div id="consoleContainer">
            <div id="consoleResizeHandle" on-down="_consoleResizeStart">
                <div id="consoleLabel">CONSOLE</div>
            </div>
            <iframe id="console" frameborder="0" src="/console.html"></iframe>
        </div>

        <button id="editorToggleButton" on-tap="_toggleEditor"></button>

    </template>
</dom-module>

<script>
    Polymer({
        is: 'or-editor-shell',
        properties: {
            editorMinWidth: {
                type: Number,
                value: 500
            },
            consoleWidth: {
                type: Number,
                value: 320
            },
            consoleResizeHandleWidth: {
                type: Number,
                value: 25
            },
            consoleResizeThreshold: {
                type: Number,
                value: 0
            },
            consoleResizeSnapRightThreshold: {
                type: Number,
                value: 200
            },
            editorVisible: {
                type: Boolean,
                reflectToAttribute: true
            },
            _consoleResizeInProgress: {
                type: Number,
                value: null
            }
        },
        attached: function () {
            this.editorVisible = !this.editorVisible; // The "opposite" of what the user wants as initial state
            this._toggleEditor();

            document.documentElement.addEventListener("wheel", function(e) {
                console.log("### WHEEL" + e);
            }, true);

        },
        _toggleEditor: function () {
            if (this.editorVisible) {
                this._hideEditor();
            } else {
                this._showEditor();
            }
        },
        _showEditor: function () {
            this.$.editor.style.display = "inherit";
            this.$.editor.src = "editor.html";
            this.$.consoleContainer.style.flexBasis = this.consoleWidth + "px";
            this.$.consoleResizeHandle.style.minWidth = this.consoleResizeHandleWidth + "px";
            this.$.consoleResizeHandle.style.display = "inherit";
            this.editorVisible = true;
        },
        _hideEditor: function () {
            this.$.editor.style.display = "none";
            this.$.editor.src = "about:blank";
            this.$.consoleContainer.style.flexBasis = "100vw";
            this.$.consoleResizeHandle.style.minWidth = "0";
            this.$.consoleResizeHandle.style.display = "none";
            this.editorVisible = false;
        },
        _consoleResizeStart: function (e, detail) {

            this.$.editor.style.pointerEvents = "none";
            this.$.console.style.pointerEvents = "none";
            document.documentElement.addEventListener("mousemove", this._consoleResizeMove.bind(this), false);
            document.documentElement.addEventListener("mouseup", this._consoleResizeEnd.bind(this), false);
            document.documentElement.addEventListener("touchmove", this._consoleResizeMove.bind(this), false);
            document.documentElement.addEventListener("touchend", this._consoleResizeEnd.bind(this), false);
            this._consoleResizeInProgress = {cursor: detail.x, panelWidth: this.$.consoleContainer.clientWidth};
        },
        _consoleResizeMove: function (e) {

            var x = e.clientX;
            if (this._consoleResizeInProgress) {

                var cursorOffset = this._consoleResizeInProgress.cursor - x;
                var newWidth = this._consoleResizeInProgress.panelWidth + cursorOffset;

                // Only move if diff is larger than threshold, might look choppy but avoids too many events
                if (Math.abs(this.$.consoleContainer.clientWidth - newWidth) < this.consoleResizeThreshold) {
                    return;
                }

                // Snap to right border if we are getting close and still moving towards the right
                if (x > document.documentElement.clientWidth - this.consoleResizeSnapRightThreshold && cursorOffset < 0) {
                    newWidth = this.consoleResizeHandleWidth;
                }

                // Stay within bounds
                if (newWidth >= this.consoleResizeHandleWidth
                        && newWidth + this.editorMinWidth < document.documentElement.clientWidth + 10) {
                    this._consoleResize(newWidth);
                }
            }
        },
        _consoleResizeEnd: function (e) {
            if (this._consoleResizeInProgress) {

                this.$.editor.style.pointerEvents = "auto";
                this.$.console.style.pointerEvents = "auto";
                document.documentElement.removeEventListener("mousemove", this._consoleResizeMove);
                document.documentElement.removeEventListener("mouseup", this._consoleResizeEnd);
                document.documentElement.removeEventListener("touchmove", this._consoleResizeMove);
                document.documentElement.removeEventListener("touchend", this._consoleResizeEnd);
                this._consoleResizeInProgress = null;
            }
        },
        _consoleResize: function (width) {
            this.$.consoleContainer.style.flexBasis = width + "px";
            this.consoleWidth = width;
        }
    })
    ;
</script>
