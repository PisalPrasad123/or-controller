<script src="../util.js"></script>
<script src="../../gwt/Client/Client.nocache.js"></script>
<script src="../../bower_components/draggabilly/dist/draggabilly.pkgd.min.js"></script>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../shared/or-component-behaviors.html">

<link rel="import" href="or-console-widget-composite.html"/>
<link rel="import" href="or-console-widget-slot.html"/>

<link rel="import" href="or-console-widget-textlabel.html"/>
<link rel="import" href="or-console-widget-pushbutton.html"/>
<link rel="import" href="or-console-widget-slider.html"/>
<link rel="import" href="or-console-widget-togglebutton.html"/>

<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">

<script>
    function onGwtReadyClient() {
        waitUntil(function () {
            return window.Polymer;
        }, 100, 50, function () {
            document.dispatchEvent(new CustomEvent("gwtReadyClient"));
        });
    }

    document.addEventListener("gwtReadyClient", function () {

        Polymer({
            is: 'or-console',
            behaviors: [openremote.PresenterAware],
            properties: {
                _presenter: {
                    type: Object,
                    value: function () {
                        return new openremote.console.ConsolePresenter(this);
                    }
                },
                minimized: {
                    type: Boolean,
                    value: false
                },
                _haveWidgets: {
                    type: Boolean,
                    value: false
                },
                _draggableWidgets: {
                    type: Array,
                    value: []
                }
            },
            listeners: {
                "console-refreshed": "_onConsoleRefreshed"
            },
            observers: [
                "_onMaximized(_presenter.maximized)",
                "_onEditMode(_presenter.editMode)",
                "_onZoomFactor(_presenter.zoomFactor)"
            ],
            attached: function () {
                if (this.minimized) {
                    this._presenter.switchConsole();
                }
            },
            _onConsoleRefreshed: function (ce, event) {
                this.set("_haveWidgets", event.renderedWidgets);

                var widgets = Polymer.dom(this.$.widgetComponentContainer).childNodes;
                this.set("_draggableWidgets", []);
                widgets.forEach(function (widget) {

                    // TODO: evil hack fixes zoom artifacts on chrome
                    widget.style["-webkit-backface-visibility"] = "hidden";

                    var draggableWidget = new Draggabilly(widget, {
                        grid: [10, 10]
                    });

                    draggableWidget.on("staticClick", function (event, pointer) {
                        if (draggableWidget.isEnabled) {
                            var nodeId = draggableWidget.element.nodeId;
                            if (nodeId) {
                                this._presenter.widgetSelected(nodeId);
                            }
                        }
                    }.bind(this));

                    draggableWidget.on("dragStart", function (event, pointer) {
                        draggableWidget.element.style.cursor = "move";
                    });

                    draggableWidget.on("dragEnd", function (event, pointer) {
                        draggableWidget.element.style.cursor = "pointer";
                        draggableWidget.element.onDragEnd(draggableWidget.element.offsetLeft, draggableWidget.element.offsetTop);
                    });

                    this.push("_draggableWidgets", draggableWidget);
                }.bind(this));

                this.async(function () {
                    if (this._presenter.editMode) {
                        this._disableDragging();
                        this._enableDragging();
                    } else {
                        this._disableDragging();
                    }
                }, 50); // TODO awful
            },
            _onMaximized: function(maximized) {
                if (maximized) {
                    this._disableDragging();
                }
            },
            _onEditMode: function(editMode) {
                if (editMode) {
                    this._enableDragging();
                } else {
                    this._disableDragging();
                }
            },
            _enableDragging: function () {
                if(!this._draggableWidgets) {
                    return;
                }
                this._draggableWidgets.forEach(function (draggable) {
                    draggable.enable();
                    draggable.element.style.cursor = "pointer";
                    draggable.element.set("draggable", true);
                    this.toggleClass("draggable", true, draggable.element);
                    draggable.element.set("draggable", true);
                    draggable.element.set("draggable", true);
                }.bind(this));
                this.updateStyles();
            },
            _disableDragging: function () {
                if(!this._draggableWidgets) {
                    return;
                }
                this._draggableWidgets.forEach(function (draggable) {
                    draggable.disable();
                    draggable.element.style.cursor = "";
                    draggable.element.set("draggable", false);
                    this.toggleClass("draggable", false, draggable.element);
                }.bind(this));
                this.updateStyles();
            },
            _onZoomFactor: function (zoomFactor) {
                this.$.widgetComponentContainer.style.transform = "scale(" + zoomFactor + ")";
                this.$.widgetComponentContainer.style["-webkit-transform"] = "scale(" + zoomFactor + ")";
                this.$.widgetComponentContainer.style.transformOrigin = "0 0";
                this.$.widgetComponentContainer.style["-webkit-transform-origin"] = "0 0";
            }
        });
    });
</script>

<dom-module id="or-console">
    <template>
        <style>

            :host {
                display: block;
                position: absolute;
                height: 100%;
                width: 100%;
                background-color: var(--or-console-background-color);
                color: var(--or-console-color);
            }

            #empty {
                color: var(--or-console-empty-color);
                padding: 1em;
                pointer-events: none;
            }

            #widgetComponentContainer {
                white-space: nowrap;
                cursor: default;
                position: relative;
            }

            .draggable:before {
                content: "";
                border-radius: 5px;
                width: 15px;
                height: 20px;
                position: absolute;
                left: -17px;
                top: 0;
                background-color: var(--or-console-widget-draggable-color);
            }

            .selected.draggable:before {
                background-color: var(--or-console-widget-selected-color);
            }

        </style>

        <template is="dom-if" if="[[!_haveWidgets]]">
            <div id="empty">
                <h1>OpenRemote Console</h1>

                <p>
                    This is an empty panel.
                </p>

                <p>
                    Hold the mouse button or touch the screen for a few seconds to edit your panel.
                </p>
            </div>
        </template>

        <div id="widgetComponentContainer"></div>

    </template>
</dom-module>