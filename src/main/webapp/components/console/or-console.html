<script src="../util.js"></script>
<script src="../../gwt/Client/Client.nocache.js"></script>
<script src="../../bower_components/draggabilly/dist/draggabilly.pkgd.min.js"></script>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../shared/or-component-behaviors.html">

<link rel="import" href="or-console-widget-composite.html"/>
<link rel="import" href="or-console-widget-slot.html"/>

<link rel="import" href="or-console-widget-textlabel.html"/>
<link rel="import" href="or-console-widget-pushbutton.html"/>
<link rel="import" href="or-console-widget-slider.html"/>
<link rel="import" href="or-console-widget-togglebutton.html"/>

<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">

<script>
    function onGwtReadyClient() {
        waitUntil(function () {
            return window.Polymer;
        }, 100, 50, function () {
            document.dispatchEvent(new CustomEvent("gwtReadyClient"));
        });
    }

    document.addEventListener("gwtReadyClient", function () {

        Polymer({
            is: 'or-console',
            behaviors: [openremote.PresenterAware],
            properties: {
                _presenter: {
                    type: Object,
                    value: function () {
                        return new openremote.console.ConsolePresenter(this);
                    }
                },
                minimized: {
                    type: Boolean,
                    value: false
                },
                _haveWidgets: {
                    type: Boolean,
                    value: false
                },
                _draggableWidgets: {
                    type: Array,
                    value: []
                },
                _zoomFactor: {
                    type: Number,
                    value: 1.0
                },
                _guideFrames: {
                    type: Array,
                    value: [
                        {label: "No Frame", width: 0, height: 0},
                        {label: "RPi Landscape", width: 800, height: 480},
                        {label: "RPi Portrait", width: 480, height: 800},
                        {label: "iPhone 6 Landscape", width: 480, height: 320},
                        {label: "iPhone 6 Portrait", width: 320, height: 480},
                        {label: "Gear S Watch", width: 180, height: 240}
                    ]
                },
                _selectedGuideFrame: {
                    type: Object,
                    value: {label: "No Frame", width: 0, height: 0}
                }
            },
            listeners: {
                "editor-open": "_onEditorOpen",
                "editor-close": "_onEditorClose",
                "console-refreshed": "_onConsoleRefreshed"
            },
            attached: function () {
                if (this.minimized) {
                    this._switchConsole();
                }
            },
            _onEditorOpen: function () {
                this.toggleAttribute("hidden", false, this.$.editorControls);
                this._selectGuideFrame(this._selectedGuideFrame);
            },
            _onEditorClose: function () {
                this.toggleAttribute("hidden", true, this.$.editorControls);
                this._disableDragging();
                this._selectGuideFrame(this._guideFrames[0]);
            },
            _onConsoleRefreshed: function () {
                // TODO: light DOM!
                var nonCompositeWidgets = this.$.widgetComponentContainer.querySelectorAll(":not(or-console-widget-composite)");
                this.set("_haveWidgets", nonCompositeWidgets.length);

                // TODO: ugly
                if (!this._haveWidgets) {
                    this.toggleAttribute("hidden", true, this.$.guideFrame);
                } else if (this._selectedGuideFrame != this._guideFrames[0]) {
                    this.toggleAttribute("hidden", false, this.$.guideFrame);
                }


                var widgets = Polymer.dom(this.$.widgetComponentContainer).childNodes;
                this.set("_draggableWidgets", []);
                widgets.forEach(function (widget) {

                    // TODO: evil hack fixes zoom artifacts on chrome
                    widget.style["-webkit-backface-visibility"] = "hidden";

                    var draggableWidget = new Draggabilly(widget, {
                        grid: [10, 10]
                    });

                    draggableWidget.on("staticClick", function (event, pointer) {
                        if (draggableWidget.isEnabled) {
                            var nodeId = draggableWidget.element.nodeId;
                            if (nodeId) {
                                this._presenter.widgetSelected(nodeId);
                            }
                        }
                    }.bind(this));

                    draggableWidget.on("dragStart", function (event, pointer) {
                        draggableWidget.element.style.cursor = "move";
                    });

                    draggableWidget.on("dragEnd", function (event, pointer) {
                        draggableWidget.element.style.cursor = "pointer";
                        draggableWidget.element.onDragEnd(draggableWidget.element.offsetLeft, draggableWidget.element.offsetTop);
                    });

                    this.push("_draggableWidgets", draggableWidget);
                }.bind(this));

                this.async(function () {
                    if (this.$$("#editSwitch") && this.$$("#editSwitch").checked) {
                        this._disableDragging();
                        this._enableDragging();
                    } else {
                        this._disableDragging();
                    }
                });
            },
            _enableDragging: function () {
                this._draggableWidgets.forEach(function (draggable) {
                    draggable.enable();
                    draggable.element.style.cursor = "pointer";
                    draggable.element.set("draggable", true);
                    this.toggleClass("draggable", true, draggable.element);
                    draggable.element.set("draggable", true);
                    draggable.element.set("draggable", true);
                }.bind(this));
                this.updateStyles();
            },
            _disableDragging: function () {
                this._draggableWidgets.forEach(function (draggable) {
                    draggable.disable();
                    draggable.element.style.cursor = "";
                    draggable.element.set("draggable", false);
                    this.toggleClass("draggable", false, draggable.element);
                }.bind(this));
                this.updateStyles();
            },
            _onEditSwitch: function (e) {
                if (e.target.checked) {
                    this._enableDragging();
                } else {
                    this._disableDragging();
                }
            },
            _switchConsole: function (e) {
                this._presenter.switchConsole();
            },
            _zoomIn: function () {
                if (this.get("_zoomFactor") >= 2.0) {
                    return;
                }
                this.set("_zoomFactor", (parseFloat(this.get("_zoomFactor")) + 0.2).toFixed(1));
                this._zoom();
            },
            _zoomOut: function () {
                if (this.get("_zoomFactor") <= 0.5) {
                    return;
                }
                this.set("_zoomFactor", (parseFloat(this.get("_zoomFactor")) - 0.2).toFixed(1));
                this._zoom();
            },
            _resetZoom: function () {
                this.set("_zoomFactor", 1.0);
                this._zoom();
            },
            _zoom: function () {
                this.$.widgetComponentContainer.style.transform = "scale(" + this._zoomFactor + ")";
                this.$.widgetComponentContainer.style["-webkit-transform"] = "scale(" + this._zoomFactor + ")";
                this.$.widgetComponentContainer.style.transformOrigin = "0 0";
                this.$.widgetComponentContainer.style["-webkit-transform-origin"] = "0 0";
                this.$.guideFrame.style.transform = "scale(" + this._zoomFactor + ")";
                this.$.guideFrame.style["-webkit-transform"] = "scale(" + this._zoomFactor + ")";
                this.$.guideFrame.style.transformOrigin = "0 0";
                this.$.guideFrame.style["-webkit-transform-origin"] = "0 0";
            },
            _onGuideFrameSwitched: function (e) {
                this._selectGuideFrame(e.model.frame);
            },
            _selectGuideFrame: function(guideFrame) {
                this.set("_selectedGuideFrame", guideFrame);
                if (guideFrame.width == 0 || guideFrame.height == 0) {
                    this.toggleAttribute("hidden", true, this.$.guideFrame);
                    return;
                }
                this.toggleAttribute("hidden", false, this.$.guideFrame);
                this.$.guideFrame.style.width = guideFrame.width + "px";
                this.$.guideFrame.style.height = guideFrame.height+ "px";
            }
        });
    });
</script>

<dom-module id="or-console">
    <style>

        :host {
            display: block;
            position: absolute;
            height: 100%;
            width: 100%;
            background-color: var(--or-console-background-color);
            color: var(--or-console-color);
        }

        #editorControls {
            background-color: var(--or-console-toolbar-background-color);
            color: var(--or-console-toolbar-button-color);
            height: 40px;
        }

        #editorControls paper-button {
            --paper-button: {
                min-width: 3em;
            }
        }

        #editorControls paper-button /deep/ .content {
            padding: 0;
        }

        #editorControls .toggleLabel {
            color: var(--or-console-toolbar-color);
        }

        #editorControls .zoomFactor {
            font-size: smaller;
            cursor: pointer;
        }

        #consoleSwitchButton {
            position: absolute;
            right: 0;
            top: 0;
            width: 28px;
            height: 28px;
            background: transparent;
            border: 2px dotted var(--or-console-toolbar-button-color);
            margin: 4px;
            cursor: pointer;
        }

        #consoleSwitchButton:active {
            background: var(--or-console-toolbar-button-color);
            border: none;
        }

        #consoleSwitchButton:focus {
            outline: 0;
        }

        #editSwitch {
        }

        #empty {
            color: var(--or-console-empty-color);
            padding: 1em;
            pointer-events: none;
        }

        #widgetComponentContainer {
            white-space: nowrap;
            cursor: default;
            position: relative;
        }

        .draggable:before {
            content: "";
            border-radius: 5px;
            width: 15px;
            height: 20px;
            position: absolute;
            left: -17px;
            top: 0;
            background-color: var(--or-console-widget-draggable-color);
        }

        .selected.draggable:before {
            background-color: var(--or-console-widget-selected-color);
        }

        .guideFrameLabel {
            vertical-align: middle;
            font-size: x-small;
        }

        #guideFrame {
            border: 2px dashed var(--or-console-guide-color);
            width: 0;
            height: 0;
            position: absolute;
            top: 40px;
            left: 0;
            pointer-events: none;
        }

        @media all and (max-width: 380px) {
            #widgetControls {
                display: none;
            }
        }

    </style>
    <template>
        <div id="editorControls" hidden class="layout horizontal center">

            <div id="widgetControls" class="flex layout horizontal center">
                <template is="dom-if" if="[[_haveWidgets]]">

                    <paper-toggle-button id="editSwitch"
                                         on-change="_onEditSwitch"
                                         style="margin: 0 0.5em;">
                    </paper-toggle-button>
                    <span class="toggleLabel">EDIT</span>

                    <div class="flex layout horizontal center center-justified">

                        <paper-menu-button no-animations
                                           horizontal-align="right"
                                           vertical-align="top"
                                           vertical-offset="20"
                                           horizontal-offset="0">
                            <paper-button class="dropdown-trigger">
                                <iron-icon icon="editor:border-outer"></iron-icon>
                                <span class="guideFrameLabel">[[_selectedGuideFrame.label]]</span>
                            </paper-button>
                            <paper-menu id="dependencyTree" class="dropdown-content">
                                <template is="dom-repeat" items="[[_guideFrames]]" as="frame">
                                    <paper-item on-tap="_onGuideFrameSwitched">[[frame.label]]</paper-item>
                                </template>
                            </paper-menu>
                        </paper-menu-button>

                        <paper-button on-tap="_zoomIn">
                            <iron-icon icon="zoom-in"></iron-icon>
                        </paper-button>
                        <div class="zoomFactor" on-tap="_resetZoom"><span>[[_zoomFactor]]</span></div>
                        <paper-button on-tap="_zoomOut">
                            <iron-icon icon="zoom-out"></iron-icon>
                        </paper-button>

                    </div>
                </template>
            </div>

            <template is="dom-if" if="[[!_presenter.maximixed]]">
                <button id="consoleSwitchButton" on-tap="_switchConsole"></button>
            </template>

        </div>

        <template is="dom-if" if="[[!_haveWidgets]]">
            <div id="empty">
                <h1>OpenRemote Console</h1>

                <p>
                    This is an empty panel.
                </p>

                <p>
                    Hold the mouse button or touch the screen for a few seconds to edit your panel.
                </p>
            </div>
        </template>

        <div id="guideFrame" hidden></div>

        <div id="widgetComponentContainer"></div>

    </template>
</dom-module>