<script>
    window.openremote = window.openremote || {};

    window.openremote.ValueAwareWidget = {

        properties: {
            value: {
                type: String,
                observer: "_onValueChange"
            }
        },
        listeners: {
            "update-value": "_onUpdateValue"
        },
        ready: function () {
            Polymer.dom(this).classList.add("or-console-widget");
        },
        _onValueChange: function (newValue, oldValue) {
            // When the value changes on a widget, we push it up to the parent widget (it's host)
            var parent = Polymer.dom(this).parentNode;
            if (parent && parent.host && parent.host.classList.contains("or-console-widget")) {
                parent.host.setAttribute("value", newValue);
            }
        },
        _onUpdateValue: function (event, detail) {
            var updatedValue = detail.value;
            // When a widget fires an update event, we push it down until we hit a sink that sends a message
            var widgets = this.querySelectorAll(".or-console-widget");
            for (var i = 0; i < widgets.length; i++) {
                var widget = widgets[i];
                this.fire("update-value", detail, {bubbles: false, node: widget});
            }
        },
        updateValue: function (value) {
            this.fire("update-value", {value: value}, {bubbles: false});
        },
        trigger: function () {
            this.updateValue(1);
        }
    };

    window.openremote.PropertiesAwareWidget = {
        properties: {
            _presenter: {
                type: Object,
                value: function () {
                    return new openremote.console.ConsoleWidgetPresenter(this);
                }
            },
            nodeId: {
                type: String,
                reflectToAttribute: true
            },
            widgetProperties: {
                type: Object,
                value: undefined
            }
        },
        observers: [
            "_onWidgetPropertiesChanged(widgetProperties.*)"
        ],
        _onWidgetPropertiesChanged: function (event) {
            if (event.path != "widgetProperties") {
                this._presenter.widgetPropertiesChanged(this.nodeId, this.widgetProperties);
            }
            this.onWidgetPropertiesChanged();
        },
        onWidgetPropertiesChanged: function() {
        }
    };

    window.openremote.VisibleWidget = {
        properties: {
            draggable: {
                type: Boolean,
                observer: "_onDraggableChanged"
            }
        },
        _onDraggableChanged: function (draggable) {
            var controls = this.querySelectorAll(".control");
            for (var i = 0; i < controls.length; i++) {
                var control = controls[i];
                control.style.pointerEvents = draggable ? "none" : "";
            }
        },
        onDragEnd: function(x, y) {
            this.set("widgetProperties.positionX", x);
            this.set("widgetProperties.positionY", y);
        },
        onWidgetPropertiesChanged: function() {
            this.style.left = this.widgetProperties.positionX + "px";
            this.style.top = this.widgetProperties.positionY + "px";
        }
    };

    window.openremote.Widget = [openremote.ValueAwareWidget, openremote.PropertiesAwareWidget, openremote.VisibleWidget];


</script>
