<link rel="import" href="../shared/or-panel.html">

<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<script>
    document.addEventListener("gwtReadyClient", function () {
        Polymer({
            is: 'or-editor-flow-control',
            behaviors: [openremote.PresenterAware],
            properties: {
                _presenter: {
                    type: Object,
                    value: function () {
                        return new openremote.editor.flow.control.FlowControlPresenter(this);
                    }
                }
            },
            listeners: {
                "flow-control-start": "_onFlowControlStart",
                "flow-control-stop": "_onFlowControlStop"
            },
            observers: [
                "_flowStatusDetailUpdated(_presenter.flowStatusDetail)",
                "_flowUnsavedUpdated(_presenter.unsaved)",
                "_flowPropertyChanged(_presenter.flow.label)"
            ],
            _onFlowControlStart: function () {
                this.toggleAttribute("hidden", false, this.$.panel);
            },
            _onFlowControlStop: function () {
                this.toggleAttribute("hidden", true, this.$.panel);
            },
            _flowStatusDetailUpdated: function (flowStatusDetail) {
                this.toggleAttribute("disabled", !flowStatusDetail || !flowStatusDetail.canStart, this.$.startButton);
                this.toggleAttribute("disabled", !flowStatusDetail || !flowStatusDetail.canStop, this.$.stopButton);
            },
            _flowUnsavedUpdated: function (unsaved) {
                this.toggleAttribute("disabled", unsaved, this.$.deleteButton);
            },
            _flowPropertyChanged: function (value) {
                if (value === undefined)
                    return;
                this._presenter.flowPropertyChanged();
            },
            _getSuperFlowDependencyStyle: function (level) {
                return "margin-left: " + (level * 20) + "px;";
            },
            _getCurrentFlowDependencyStyle: function (level) {
                return "font-weight: bold;";
            },
            _getSubFlowDependencyStyle: function (level) {
                return "margin-left: " + (level * 20) + "px;";
            },
            _editFlowDependency: function (event) {
                this._presenter.editFlowDependency(event.model.flowDependency);
            },
            _redeployFlow: function () {
                this._presenter.redeployFlow();
            },
            _saveFlow: function () {
                this._presenter.saveFlow();
            },
            _stopFlow: function () {
                this._presenter.stopFlow();
            },
            _startFlow: function () {
                this._presenter.startFlow();
            },
            _deleteFlow: function () {
                this._presenter.deleteFlow();
            },
            _exportFlow: function () {
                console.log(this._presenter.exportFlow());
            }
        });
    });
</script>

<dom-module id="or-editor-flow-control">

    <style>
        :host {
            position: absolute;
            top: 10px;
            left: 10px;
        }

        #panel {
            --or-panel-width: 400px;
            --or-panel-max-height: 100px;
        }

        .content {
            padding: 0 0.4em;
        }

        .flowStatus {
            font-weight: bold;
            color: var(--or-editor-mark-default-color, black);
        }

        .flowStatus .deployed {
            color: var(--or-editor-mark-deployed-color, green);
        }

        .flowStatus .deploying {
            color: var(--or-editor-mark-deploying-color, yellow);
        }

        .flowStatus .problem {
            color: var(--or-editor-mark-problem-color, red);
        }

        .flowStatus.indicator {
            display: inline-block;
            line-height: 0;
            vertical-align: middle;
            color: var(--or-editor-mark-default-color, black);
        }

        .flowStatus.indicator > span:before {
            content: ' \25CF';
            font-size: 30px;
            vertical-align: sub;
        }

        #dependencyTree .superDependency,
        #dependencyTree .subDependency {
        }

        #dependencyTree .superDependency:before {
            content: ' \2197';
            font-size: 0.5em;
            vertical-align: bottom;
            font-weight: bold;
            margin: 0 0.8em;
            color: var(--or-editor-flow-item-background-color);
        }

        #dependencyTree .subDependency:before {
            content: ' \2198';
            font-size: 0.5em;
            vertical-align: top;
            font-weight: bold;
            margin: 0 0.8em;
            color: var(--or-editor-flow-item-background-color);
        }

        #dependencyTree .superDependency.empty,
        #dependencyTree .subDependency.empty {
            font-style: italic;
            text-transform: initial;
            color: var(--or-editor-flow-item-background-color);
        }


    </style>

    <template>
        <or-panel id="panel"
                  switchable="left"
                  title="[[_presenter.flowControlTitle]]"
                  dirty="[[_presenter.flowControlDirty]]"
                  hidden>

            <div class="titleToolbar">

                <div class="flowStatus indicator">
                    <span class$="[[_presenter.flowStatusDetail.mark]]"></span>
                </div>

                <paper-button on-tap="_redeployFlow">
                    <iron-icon icon="refresh"></iron-icon>
                </paper-button>

                <paper-menu-button no-animations horizontal-align="right" vertical-align="top" vertical-offset="20">
                    <paper-button class="dropdown-trigger">
                        <iron-icon icon="arrow-drop-down-circle"></iron-icon>
                    </paper-button>
                    <paper-menu id="dependencyTree" class="dropdown-content">
                        <template is="dom-repeat" items="[[_presenter.flowSuperDependencies]]" as="flowDependency">
                            <div>
                                <paper-button on-tap="_editFlowDependency"
                                              style$="[[_getSuperFlowDependencyStyle(flowDependency.level)]]">
                                    <span class="superDependency">
                                        <span>[[flowDependency.label]]</span>
                                        <template is="dom-if" if="[[flowDependency.wired]]">
                                            <span>&#160;(WIRED)</span>
                                        </template>
                                    </span>
                                </paper-button>
                            </div>
                        </template>
                        <template is="dom-if" if="[[!_presenter.flowSuperDependencies.length]]">
                            <paper-button style$="[[_getSuperFlowDependencyStyle(0)]]">
                                <span class="superDependency empty">Not included in other flows</span>
                            </paper-button>
                        </template>
                        <div>
                            <paper-button
                                    style$="[[_getCurrentFlowDependencyStyle()]]">
                                <span class="currentFlow">[[_presenter.flow.label]]</span>
                            </paper-button>
                        </div>
                        <template is="dom-if" if="[[!_presenter.flowSubDependencies.length]]">
                            <paper-button style$="[[_getSubFlowDependencyStyle(0)]]">
                                <span class="subDependency empty">No included flows</span>
                            </paper-button>
                        </template>
                        <template is="dom-repeat" items="[[_presenter.flowSubDependencies]]" as="flowDependency">
                            <div>
                                <paper-button on-tap="_editFlowDependency"
                                              style$="[[_getSubFlowDependencyStyle(flowDependency.level)]]">
                                    <span class="subDependency">[[flowDependency.label]]</span>
                                </paper-button>
                            </div>
                        </template>
                    </paper-menu>
                </paper-menu-button>
            </div>

            <div class="topToolbar">
                <paper-button disabled id="startButton" on-tap="_startFlow">
                    <iron-icon icon="av:play-arrow"></iron-icon>
                    Start
                </paper-button>
                <paper-button id="stopButton" on-tap="_stopFlow">
                    <iron-icon icon="av:stop"></iron-icon>
                    Stop
                </paper-button>
                <paper-button id="deleteButton" on-tap="_deleteFlow">
                    <iron-icon icon="icons:delete"></iron-icon>
                    Remove
                </paper-button>
                <paper-menu-button no-animations horizontal-align="right" vertical-align="top" horizontal-offset="20"
                                   vertical-offset="20">
                    <paper-button class="dropdown-trigger">
                        <iron-icon icon="menu"></iron-icon>
                    </paper-button>
                    <paper-menu class="dropdown-content">
                        <div>
                            <paper-button on-tap="_saveFlow">
                                <iron-icon icon="icons:save"></iron-icon>
                                Save
                            </paper-button>
                        </div>
                        <div>
                            <paper-button on-tap="_exportFlow">
                                <iron-icon icon="communication:call-made"></iron-icon>
                                Export
                            </paper-button>
                        </div>
                        <div>
                            <paper-button on-tap="_importFlow">
                                <iron-icon icon="communication:call-received"></iron-icon>
                                Import
                            </paper-button>
                        </div>
                    </paper-menu>
                </paper-menu-button>
            </div>

            <div class="content">
                <div class="form">
                    <div class="formItem">
                        <div class="formLabel">Status:</div>
                        <div class="formValue">
                            <div class="flowStatus">
                                <span class$="[[_presenter.flowStatusDetail.mark]]">[[_presenter.flowStatusDetail.text]]</span>
                            </div>
                        </div>
                    </div>
                    <div class="formItem">
                        <div class="formValue">
                            <paper-input label="Label"
                                         value="{{_presenter.flow.label}}"></paper-input>
                        </div>
                    </div>
                </div>
            </div>

        </or-panel>

    </template>
</dom-module>

