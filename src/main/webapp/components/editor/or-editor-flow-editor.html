<link rel="import" href="or-editor-flow-node.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">

<script>
    document.addEventListener("gwtReadyClient", function () {
        Polymer({
            is: 'or-editor-flow-editor',
            behaviors: [openremote.PresenterAware],
            properties: {
                _presenter: {
                    type: Object,
                    value: function () {
                        return new openremote.editor.flow.FlowEditorPresenter(this);
                    }
                }
            },
            observers: [
                "_flowStatusDetailUpdated(_presenter.flowStatusDetail)",
                "_flowUnsavedUpdated(_presenter.flowUnsaved)",
                "_flowPropertyChanged(_presenter.flow.label)"
            ],
            _onDragEnter: function (e) {
                this.toggleClass("dragOver", true, this.$.flowDesigner);
            },
            _onDragLeave: function (e) {
                this.toggleClass("dragOver", false, this.$.flowDesigner);
            },
            _onDragOver: function (e) {
                e.preventDefault();
                if (e.dataTransfer.getData("nodeType")) {
                    e.dataTransfer.dropEffect = "copy";
                } else if (e.dataTransfer.getData("flowId")) {
                    e.dataTransfer.dropEffect = "link";
                }
            },
            _onDrop: function (e) {
                e.preventDefault();
                this.toggleClass("dragOver", false, this.$.flowDesigner);
                var nodeType = e.dataTransfer.getData("nodeType");
                var flowId = e.dataTransfer.getData("flowId");
                if (nodeType) {
                    this._presenter.createNode(nodeType, e.offsetX, e.offsetY);
                } else if (flowId) {
                    this._presenter.createSubflowNode(flowId, e.offsetX, e.offsetY);
                }
            },
            _flowStatusDetailUpdated: function (flowStatusDetail) {
                this.toggleAttribute("disabled", !flowStatusDetail || !flowStatusDetail.canStart, this.$.startButton);
                this.toggleAttribute("disabled", !flowStatusDetail || !flowStatusDetail.canStop, this.$.stopButton);
            },
            _flowUnsavedUpdated: function (unsaved) {
                this.toggleAttribute("disabled", unsaved, this.$.deleteButton);
            },
            _flowPropertyChanged: function (value) {
                if (value === undefined)
                    return;
                this._presenter.flowPropertyChanged();
            },
            _getSuperFlowDependencyStyle: function (level) {
                return "margin-left: " + (level * 20) + "px;";
            },
            _getCurrentFlowDependencyStyle: function (level) {
                return "font-weight: bold;";
            },
            _getSubFlowDependencyStyle: function (level) {
                return "margin-left: " + (level * 20) + "px;";
            },
            _getSuperFlowDependencyStatusLabel: function(dependency) {
                if (dependency.wired  && !dependency.peersInvalid) {
                    return " (Wired)";
                } else if (dependency.peersInvalid) {
                    return " (Invalid Wires)";
                }
                return "";
            },
            _editFlowDependency: function (event) {
                this._presenter.editFlowDependency(event.model.flowDependency);
            },
            _redeployFlow: function () {
                this._presenter.redeployFlow();
            },
            _saveFlow: function () {
                this._presenter.saveFlow();
            },
            _stopFlow: function () {
                this._presenter.stopFlow();
            },
            _startFlow: function () {
                this._presenter.startFlow();
            },
            _deleteFlow: function () {
                this._presenter.deleteFlow();
            },
            _exportFlow: function () {
                this._presenter.exportFlow();
            }
        });
    });
</script>

<dom-module id="or-editor-flow-editor">

    <style>
        :host {
            position: relative;
        }

        :host, #flowDesigner {
            display: block;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #flowDesigner {
        }

        #flowDesigner.dragOver {
            background: radial-gradient(#ccc 0, #ccc 15%, white 15%, white 100%);
            background-origin: padding-box;
            background-clip: border-box;
            background-size: 10px 10px;
        }

        #empty {
            padding: 0 1em;
            color: var(--or-editor-main-color);
        }

        #flowControl {
            position: absolute;
            top: 10px;
            left: 10px;
            --or-panel-width: 400px;
            --or-panel-max-height: 100px;
        }

        #flowControl .content {
            padding: 0 0.4em;
        }

        #flowControl .flowStatus {
            font-weight: bold;
            color: var(--or-editor-mark-default-color, black);
        }

        #flowControl .flowStatus .deployed {
            color: var(--or-editor-mark-deployed-color, green);
        }

        #flowControl .flowStatus .deploying {
            color: var(--or-editor-mark-deploying-color, yellow);
        }

        #flowControl .flowStatus .problem {
            color: var(--or-editor-mark-problem-color, red);
        }

        #flowControl .flowStatus.indicator {
            display: inline-block;
            line-height: 0;
            vertical-align: middle;
            color: var(--or-editor-mark-default-color, black);
        }

        #flowControl .flowStatus.indicator > span:before {
            content: ' \25CF';
            font-size: 30px;
            vertical-align: sub;
        }

        #flowControl #dependencyTree .superDependency,
        #flowControl #dependencyTree .subDependency {
            white-space: nowrap;
        }

        #flowControl #dependencyTree .superDependency:before {
            content: ' \2197';
            font-size: 0.5em;
            vertical-align: bottom;
            font-weight: bold;
            margin: 0 0.8em;
            color: var(--or-editor-flow-item-background-color);
        }

        #flowControl #dependencyTree .subDependency:before {
            content: ' \2198';
            font-size: 0.5em;
            vertical-align: top;
            font-weight: bold;
            margin: 0 0.8em;
            color: var(--or-editor-flow-item-background-color);
        }

        #flowControl #dependencyTree .superDependency.empty,
        #flowControl #dependencyTree .subDependency.empty {
            font-style: italic;
            text-transform: initial;
            color: var(--or-editor-flow-item-background-color);
        }

        #flowControl #dependencyTree .superDependency > span[peersInvalid] {
            color: var(--or-editor-mark-problem-color, red);
        }

    </style>

    <template>

        <template is="dom-if" if="{{!_presenter.flow}}">
            <div id="empty">
                <h1>OpenRemote Editor</h1>

                <p>
                    Manage your things and edit your panel flows.
                </p>
            </div>
        </template>

        <div id="flowDesigner"
             on-dragenter="_onDragEnter"
             on-dragleave="_onDragLeave"
             on-dragover="_onDragOver"
             on-drop="_onDrop"></div>

        <or-panel id="flowControl"
                  switchable="left"
                  title="[[_presenter.flowControlTitle]]"
                  dirty="[[_presenter.flowDirty]]"
                  hidden$="[[!_presenter.flow]]">

            <div class="titleToolbar">

                <div class="flowStatus indicator">
                    <span class$="[[_presenter.flowStatusDetail.mark]]"></span>
                </div>

                <paper-button on-tap="_redeployFlow">
                    <iron-icon icon="refresh"></iron-icon>
                </paper-button>

                <paper-menu-button no-animations horizontal-align="left"
                                   vertical-align="top"
                                   vertical-offset="20"
                                   horizontal-offset="-100">
                    <paper-button class="dropdown-trigger">
                        <iron-icon icon="arrow-drop-down-circle"></iron-icon>
                    </paper-button>
                    <paper-menu id="dependencyTree" class="dropdown-content">
                        <template is="dom-repeat" items="[[_presenter.flowSuperDependencies]]" as="flowDependency">
                            <div>
                                <paper-button on-tap="_editFlowDependency"
                                              style$="[[_getSuperFlowDependencyStyle(flowDependency.level)]]">
                                    <span class="superDependency">
                                        <span>[[flowDependency.label]]</span>
                                        <span peersInvalid$="[[flowDependency.peersInvalid]]">[[_getSuperFlowDependencyStatusLabel(flowDependency)]]</span>
                                    </span>
                                </paper-button>
                            </div>
                        </template>
                        <template is="dom-if" if="[[!_presenter.flowSuperDependencies.length]]">
                            <paper-button style$="[[_getSuperFlowDependencyStyle(0)]]">
                                <span class="superDependency empty">Not included in other flows</span>
                            </paper-button>
                        </template>
                        <div>
                            <paper-button
                                    style$="[[_getCurrentFlowDependencyStyle()]]">
                                <span class="currentFlow">[[_presenter.flow.label]]</span>
                            </paper-button>
                        </div>
                        <template is="dom-if" if="[[!_presenter.flowSubDependencies.length]]">
                            <paper-button style$="[[_getSubFlowDependencyStyle(0)]]">
                                <span class="subDependency empty">No included flows</span>
                            </paper-button>
                        </template>
                        <template is="dom-repeat" items="[[_presenter.flowSubDependencies]]" as="flowDependency">
                            <div>
                                <paper-button on-tap="_editFlowDependency"
                                              style$="[[_getSubFlowDependencyStyle(flowDependency.level)]]">
                                    <span class="subDependency">[[flowDependency.label]]</span>
                                </paper-button>
                            </div>
                        </template>
                    </paper-menu>
                </paper-menu-button>
            </div>

            <div class="topToolbar">
                <paper-button disabled id="startButton" on-tap="_startFlow">
                    <iron-icon icon="av:play-arrow"></iron-icon>
                    Start
                </paper-button>
                <paper-button id="stopButton" on-tap="_stopFlow">
                    <iron-icon icon="av:stop"></iron-icon>
                    Stop
                </paper-button>
                <paper-button id="deleteButton" on-tap="_deleteFlow">
                    <iron-icon icon="icons:delete"></iron-icon>
                    Remove
                </paper-button>
                <paper-menu-button no-animations horizontal-align="right" vertical-align="top" horizontal-offset="20"
                                   vertical-offset="20">
                    <paper-button class="dropdown-trigger">
                        <iron-icon icon="menu"></iron-icon>
                    </paper-button>
                    <paper-menu class="dropdown-content">
                        <div>
                            <paper-button on-tap="_saveFlow">
                                <iron-icon icon="icons:save"></iron-icon>
                                Save
                            </paper-button>
                        </div>
                        <div>
                            <paper-button on-tap="_exportFlow">
                                <iron-icon icon="communication:call-made"></iron-icon>
                                Export
                            </paper-button>
                        </div>
                        <div>
                            <paper-button on-tap="_importFlow">
                                <iron-icon icon="communication:call-received"></iron-icon>
                                Import
                            </paper-button>
                        </div>
                    </paper-menu>
                </paper-menu-button>
            </div>

            <div class="content">
                <div class="form">
                    <div class="formItem">
                        <div class="formLabel">Status:</div>
                        <div class="formValue">
                            <div class="flowStatus">
                                <span class$="[[_presenter.flowStatusDetail.mark]]">[[_presenter.flowStatusDetail.text]]</span>
                            </div>
                        </div>
                    </div>
                    <div class="formItem">
                        <div class="formValue">
                            <paper-input label="Label"
                                         value="{{_presenter.flow.label}}"></paper-input>
                        </div>
                    </div>
                </div>
            </div>

        </or-panel>

        <or-editor-flow-node id="flowNode"></or-editor-flow-node>

    </template>
</dom-module>

